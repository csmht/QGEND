name: æ¯æ—¥åŸŸåWHOISä¸SSLè¯ä¹¦æ£€æµ‹

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è¿è¡Œ
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-domain-cert:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: å®‰è£…WHOISå’Œjqå·¥å…·
        run: sudo apt-get update && sudo apt-get install -y whois jq

      # æ–°å¢ï¼šæµ‹è¯•é£ä¹¦æ¶ˆæ¯è¿é€šæ€§ï¼ˆå·¥ä½œæµå¼€å§‹æ—¶å‘é€æµ‹è¯•æ¶ˆæ¯ï¼‰
      - name: æµ‹è¯•é£ä¹¦æ¶ˆæ¯å‘é€
        run: |
          TEST_CONTENT=$(cat <<EOF
          {
            "msg_type": "text",
            "content": {
              "text": "ğŸ“¡ é£ä¹¦æ¶ˆæ¯æµ‹è¯•ï¼šé€šçŸ¥é€šé“æ­£å¸¸\nå·¥ä½œæµå¼€å§‹æ‰§è¡ŒåŸŸå/è¯ä¹¦æ£€æµ‹ä»»åŠ¡"
            }
          }
          EOF
          )
          
          # å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°æŒ‡å®šWebHook
          curl -X POST \
            "https://open.feishu.cn/open-apis/bot/v2/hook/e7b9814a-2005-4d48-8861-2b251ffe0cf6" \
            -H "Content-Type: application/json" \
            -d "$TEST_CONTENT"
        env:
          SHELL: /bin/bash

      # æ£€æŸ¥ä¸»åŸŸåWHOISä¿¡æ¯ï¼ˆä¿æŒä¸å˜ï¼‰
      - name: æ£€æŸ¥ä¸»åŸŸå bushanyanchi.com WHOISä¿¡æ¯
        id: check_domain_whois
        run: |
          MAIN_DOMAIN="bushanyanchi.com"
          whois $MAIN_DOMAIN > whois_result.txt
          
          EXPIRE_TIME=$(grep -iE 'Registry Expiry Date|Expiration Date|expires|Expiry Date' whois_result.txt | head -1 | awk -F': ' '{print $2}' | xargs)
          EXPIRE_TIME_CLEAN=$(echo $EXPIRE_TIME | sed 's/T/ /g' | sed 's/Z//g')
          
          if [ -n "$EXPIRE_TIME_CLEAN" ]; then
            EXPIRE_TIMESTAMP=$(date -d "$EXPIRE_TIME_CLEAN" +%s 2>/dev/null)
            CURRENT_TIMESTAMP=$(date +%s)
            REMAIN_DAYS=$(( (EXPIRE_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
          
            if [ $REMAIN_DAYS -lt 0 ]; then
              REMAIN_DAYS="å·²è¿‡æœŸï¼ˆ$((-REMAIN_DAYS)) å¤©ï¼‰"
              DOMAIN_RISK="ğŸš¨ ä¸»åŸŸåå·²è¿‡æœŸï¼è¯·ç«‹å³å¤„ç†ï¼"
            elif [ $REMAIN_DAYS -lt 14 ]; then
              REMAIN_DAYS="$REMAIN_DAYS å¤©ï¼ˆå³å°†è¿‡æœŸï¼‰"
              DOMAIN_RISK="âš ï¸ ä¸»åŸŸåå‰©ä½™å¤©æ•°ä¸è¶³14å¤©ï¼Œéœ€å°½å¿«ç»­è´¹ï¼"
            else
              REMAIN_DAYS="$REMAIN_DAYS å¤©"
              DOMAIN_RISK=""
            fi
          else
            EXPIRE_TIME="æœªæŸ¥è¯¢åˆ°"
            REMAIN_DAYS="æœªçŸ¥"
            DOMAIN_RISK="â“ æ— æ³•è·å–åŸŸååˆ°æœŸä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
          fi
          
          echo "expire_time=$EXPIRE_TIME" >> $GITHUB_OUTPUT
          echo "remain_days=$REMAIN_DAYS" >> $GITHUB_OUTPUT
          echo "domain_risk=$DOMAIN_RISK" >> $GITHUB_OUTPUT

      # æ£€æŸ¥å­åŸŸåSSLè¯ä¹¦ï¼ˆä¿æŒä¸å˜ï¼‰
      - name: æ£€æŸ¥å­åŸŸåSSLè¯ä¹¦
        id: check_subdomain_cert
        run: |
          SUB_DOMAINS=("gk.bushanyanchi.com" "gk-admin.bushanyanchi.com")
          CERT_RESULTS=""
          CERT_RISK=""
          
          for DOMAIN in "${SUB_DOMAINS[@]}"; do
            CERT=$(echo | timeout 10s openssl s_client -connect $DOMAIN:443 -servername $DOMAIN 2>/dev/null | openssl x509 -noout -dates 2>/dev/null)
          
            if [ -n "$CERT" ]; then
              NOT_BEFORE=$(echo "$CERT" | grep 'notBefore' | awk -F'=' '{print $2}' | xargs)
              NOT_AFTER=$(echo "$CERT" | grep 'notAfter' | awk -F'=' '{print $2}' | xargs)
              NOT_AFTER_TIMESTAMP=$(date -d "$NOT_AFTER" +%s 2>/dev/null)
              CURRENT_TIMESTAMP=$(date +%s)
              REMAIN_DAYS=$(( (NOT_AFTER_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
          
              if [ $REMAIN_DAYS -lt 0 ]; then
                REMAIN_DAYS="å·²è¿‡æœŸï¼ˆ$((-REMAIN_DAYS)) å¤©ï¼‰"
                CERT_RISK+="ğŸš¨ $DOMAIN è¯ä¹¦å·²è¿‡æœŸï¼è¯·ç«‹å³æ›´æ–°ï¼\n"
              elif [ $REMAIN_DAYS -lt 14 ]; then
                REMAIN_DAYS="$REMAIN_DAYS å¤©ï¼ˆå³å°†è¿‡æœŸï¼‰"
                CERT_RISK+="âš ï¸ $DOMAIN è¯ä¹¦å‰©ä½™å¤©æ•°ä¸è¶³14å¤©ï¼Œéœ€å°½å¿«æ›´æ–°ï¼\n"
              else
                REMAIN_DAYS="$REMAIN_DAYS å¤©"
              fi
            else
              NOT_BEFORE="æœªè·å–åˆ°è¯ä¹¦"
              NOT_AFTER="æœªè·å–åˆ°è¯ä¹¦"
              REMAIN_DAYS="æ— æ³•è¿æ¥ï¼ˆæ£€æŸ¥åŸŸåè§£ææˆ–443ç«¯å£ï¼‰"
              CERT_RISK+="âŒ $DOMAIN æ— æ³•è·å–è¯ä¹¦ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ï¼\n"
            fi
          
            CERT_RESULTS+="ğŸ”¹ $DOMAIN\n   - ç”Ÿæ•ˆæ—¶é—´ï¼š$NOT_BEFORE\n   - åˆ°æœŸæ—¶é—´ï¼š$NOT_AFTER\n   - å‰©ä½™å¤©æ•°ï¼š$REMAIN_DAYS\n\n"
          done
          
          echo "cert_results=$CERT_RESULTS" >> $GITHUB_OUTPUT
          echo "cert_risk=$CERT_RISK" >> $GITHUB_OUTPUT

      # å‘é€é£ä¹¦æ£€æµ‹æŠ¥å‘Šï¼ˆä¿æŒä¸å˜ï¼‰
      - name: å‘é€é£ä¹¦æ£€æµ‹æŠ¥å‘Š
        run: |
          ALL_RISKS=$(cat <<EOF
          ${{ steps.check_domain_whois.outputs.domain_risk }}
          ${{ steps.check_subdomain_cert.outputs.cert_risk }}
          EOF
          )
          
          NOTIFY_CONTENT=$(cat <<EOF
          {
            "msg_type": "markdown",
            "content": {
              "title": "ğŸŒ æ¯æ—¥åŸŸåä¸è¯ä¹¦æ£€æµ‹æŠ¥å‘Š",
              "text": "### ä¸»åŸŸå WHOIS æ£€æŸ¥\n"
                      "ğŸ”¸ åŸŸåï¼šbushanyanchi.com\n"
                      "   - åˆ°æœŸæ—¶é—´ï¼š${{ steps.check_domain_whois.outputs.expire_time }}\n"
                      "   - å‰©ä½™å¤©æ•°ï¼š${{ steps.check_domain_whois.outputs.remain_days }}\n\n"
                      "### å­åŸŸå SSL è¯ä¹¦æ£€æŸ¥\n"
                      "${{ steps.check_subdomain_cert.outputs.cert_results }}"
                      "$([ -n "$ALL_RISKS" ] && echo "### é£é™©è­¦ç¤º\n$ALL_RISKS" || echo "### çŠ¶æ€æ­£å¸¸\næ‰€æœ‰åŸŸåå’Œè¯ä¹¦å‰©ä½™å¤©æ•°å‡â‰¥14å¤©")"
            }
          }
          EOF
          )
          
          curl -X POST \
            "https://open.feishu.cn/open-apis/bot/v2/hook/e7b9814a-2005-4d48-8861-2b251ffe0cf6" \
            -H "Content-Type: application/json" \
            -d "$NOTIFY_CONTENT"
        env:
          SHELL: /bin/bash