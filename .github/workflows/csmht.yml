name: Extract Image and Git Branch with Warnings
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - '**.yaml'

jobs:
  extract-info:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºå½“å‰ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šå®‰è£… yq å·¥å…·
      - name: Install yq
        run: |
          if ! command -v yq &> /dev/null; then
            echo "âš ï¸ yq not found, installing now..."
            sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
            sudo chmod +x /usr/bin/yq
          else
            echo "âœ… yq is already installed"
          fi

      # æ­¥éª¤3ï¼šä»YAMLæå–imageå±æ€§ï¼ˆå«è­¦å‘Šï¼‰
      - name: Extract image from YAML
        id: extract-image
        run: |
          YAML_FILE="s.yaml"  # æ›¿æ¢ä¸ºå®é™…YAMLæ–‡ä»¶è·¯å¾„
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$YAML_FILE" ]; then
            echo "âš ï¸ [WARNING] YAML file '$YAML_FILE' not found in repository!"
            echo "image=unknown" >> $GITHUB_OUTPUT
            exit 0  # ä¸ä¸­æ–­å·¥ä½œæµï¼Œè¿”å›é»˜è®¤å€¼
          fi
          
          # æå–å±æ€§å€¼
          IMAGE_VALUE=$(yq eval '.resources.fcDemo.props.customContainerConfig.image' "$YAML_FILE")
          
          # æ£€æŸ¥æå–ç»“æœæ˜¯å¦ä¸ºç©º
          if [ -z "$IMAGE_VALUE" ] || [ "$IMAGE_VALUE" = "null" ]; then
            echo "âš ï¸ [WARNING] Failed to extract 'resources.fcDemo.props.customContainerConfig.image' from $YAML_FILE"
            IMAGE_VALUE="unknown"
          fi
          
          echo "âœ… Extracted image: $IMAGE_VALUE"
          echo "image=$IMAGE_VALUE" >> $GITHUB_OUTPUT

      # æ­¥éª¤4ï¼šè®¿é—®æ¥å£è·å–git_branchå’Œgit_commit_idï¼ˆå«é‡è¯•æœºåˆ¶ï¼‰
      - name: Fetch git_branch from API with retry
        id: fetch-branch
        run: |
          API_URL="https://gk-regir-docker-nvlgswjdem.cn-shenzhen.fcapp.run/ready/detail"  # å®é™…æ¥å£åœ°å€
          MAX_RETRIES=3
          RETRY_DELAY=5
          SERVER_DOWN=false

          # æ£€æŸ¥æ¥å£URLæ˜¯å¦é…ç½®
          if [ -z "$API_URL" ] || [ "$API_URL" = "https://your-api-url.com/endpoint" ]; then
            echo "âš ï¸ [WARNING] API URL is not set or using default value! Please update API_URL."
            BRANCH_VALUE="unknown"
          else
            echo "ğŸ”„ Starting API request with retry mechanism..."

            for i in $(seq 1 $MAX_RETRIES); do
              echo "Attempt $i/$MAX_RETRIES..."

              # å‘é€è¯·æ±‚ï¼Œè®¾ç½®100ç§’è¶…æ—¶
              BODY=$(curl -s --max-time 100 "$API_URL" 2>&1)
              CURL_EXIT_CODE=$?
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 100 "$API_URL" 2>&1)

              echo "CURL exit code: $CURL_EXIT_CODE"
              echo "HTTP status code: $HTTP_CODE"

              # æ£€æŸ¥curlå‘½ä»¤æ‰§è¡ŒçŠ¶æ€
              if [ $CURL_EXIT_CODE -ne 0 ]; then
                echo "âŒ Request failed with curl error: $BODY"
                if [ $i -eq $MAX_RETRIES ]; then
                  echo "ğŸš¨ All $MAX_RETRIES attempts failed. Server appears to be down."
                  SERVER_DOWN=true
                  BRANCH_VALUE="server_down"
                else
                  echo "â³ Retrying in ${RETRY_DELAY} seconds..."
                  sleep $RETRY_DELAY
                fi
                continue
              fi

              # æ£€æŸ¥HTTPçŠ¶æ€ç 
              if [ "$HTTP_CODE" -ne 200 ]; then
                echo "âŒ HTTP error: $HTTP_CODE - Response: $BODY"
                if [ $i -eq $MAX_RETRIES ]; then
                  echo "ğŸš¨ All $MAX_RETRIES attempts failed with HTTP errors."
                  SERVER_DOWN=true
                  BRANCH_VALUE="server_down"
                else
                  echo "â³ Retrying in ${RETRY_DELAY} seconds..."
                  sleep $RETRY_DELAY
                fi
                continue
              fi

              # éªŒè¯JSONæ ¼å¼
              if ! echo "$BODY" | jq empty 2>/dev/null; then
                echo "âŒ Invalid JSON response: $BODY"
                if [ $i -eq $MAX_RETRIES ]; then
                  echo "ğŸš¨ All $MAX_RETRIES attempts failed with invalid JSON."
                  SERVER_DOWN=true
                  BRANCH_VALUE="server_down"
                else
                  echo "â³ Retrying in ${RETRY_DELAY} seconds..."
                  sleep $RETRY_DELAY
                fi
                continue
              fi

              # è§£æå“åº”ä½“ä¸­çš„git_branch
              BRANCH_VALUE=$(echo "$BODY" | jq -r '.details.git_branch')
              if [ "$BRANCH_VALUE" = "null" ] || [ -z "$BRANCH_VALUE" ]; then
                echo "âŒ 'details.git_branch' not found in API response! Response: $BODY"
                if [ $i -eq $MAX_RETRIES ]; then
                  echo "ğŸš¨ All $MAX_RETRIES attempts failed - unexpected response format."
                  BRANCH_VALUE="unknown"
                else
                  echo "â³ Retrying in ${RETRY_DELAY} seconds..."
                  sleep $RETRY_DELAY
                fi
                continue
              fi

              # æˆåŠŸè·å–æ•°æ®
              echo "âœ… Successfully fetched git_branch on attempt $i"
              break
            done
          fi

          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "git_branch=$BRANCH_VALUE" >> $GITHUB_OUTPUT
          echo "server_down=$SERVER_DOWN" >> $GITHUB_OUTPUT

          echo "âœ… Final git_branch result: $BRANCH_VALUE"
          if [ "$SERVER_DOWN" = "true" ]; then
            echo "ğŸš¨ Server status: DOWN"
          else
            echo "âœ… Server status: UP"
          fi

      # æ­¥éª¤5ï¼šè·å–git_commit_idï¼ˆå¤ç”¨ä¹‹å‰APIè°ƒç”¨çš„ç»“æœï¼‰
      - name: Extract git_commit_id from API response
        id: fetch-commit
        run: |
          # æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
          if [ "${{ steps.fetch-branch.outputs.server_down }}" = "true" ]; then
            echo "âš ï¸ Server is down, cannot fetch git_commit_id"
            COMMIT_VALUE="server_down"
          elif [ "${{ steps.fetch-branch.outputs.git_branch }}" = "unknown" ]; then
            echo "âš ï¸ API response was invalid, cannot fetch git_commit_id"
            COMMIT_VALUE="unknown"
          else
            echo "âœ… Using API response from previous step to extract git_commit_id"

            # é‡æ–°å‘èµ·ä¸€æ¬¡APIè¯·æ±‚æ¥è·å–å®Œæ•´å“åº”ï¼ˆå› ä¸ºä¹‹å‰çš„å“åº”æ²¡æœ‰ä¿å­˜ï¼‰
            API_URL="https://gk-regir-docker-nvlgswjdem.cn-shenzhen.fcapp.run/ready/detail"

            # ä½¿ç”¨ç›¸åŒçš„é‡è¯•æœºåˆ¶ï¼Œä½†åªå°è¯•1æ¬¡å› ä¸ºå‰é¢å·²ç»éªŒè¯äº†æœåŠ¡å™¨çŠ¶æ€
            BODY=$(curl -s --max-time 100 "$API_URL" 2>&1)
            CURL_EXIT_CODE=$?
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 100 "$API_URL" 2>&1)

            if [ $CURL_EXIT_CODE -ne 0 ]; then
              echo "âŒ Unexpected curl error when fetching git_commit_id: $BODY"
              COMMIT_VALUE="unknown"
            elif [ "$HTTP_CODE" -ne 200 ]; then
              echo "âŒ Unexpected HTTP error when fetching git_commit_id: $HTTP_CODE"
              COMMIT_VALUE="unknown"
            else
              # éªŒè¯JSONæ ¼å¼
              if ! echo "$BODY" | jq empty 2>/dev/null; then
                echo "âŒ Invalid JSON response when fetching git_commit_id: $BODY"
                COMMIT_VALUE="unknown"
              else
                # è§£æå“åº”ä½“ä¸­çš„git_commit_id
                COMMIT_VALUE=$(echo "$BODY" | jq -r '.details.git_commit_id')
                if [ "$COMMIT_VALUE" = "null" ] || [ -z "$COMMIT_VALUE" ]; then
                  echo "âŒ 'details.git_commit_id' not found in API response! Response: $BODY"
                  COMMIT_VALUE="unknown"
                else
                  echo "âœ… Successfully extracted git_commit_id: $COMMIT_VALUE"
                fi
              fi
            fi
          fi

          echo "git_commit_id=$COMMIT_VALUE" >> $GITHUB_OUTPUT
          echo "âœ… Final git_commit_id result: $COMMIT_VALUE"

      # æ­¥éª¤6ï¼šè§£æé•œåƒæ ‡ç­¾
      - name: Parse image tag
        id: parse-image
        run: |
          IMAGE="${{ steps.extract-image.outputs.image }}"
          if [ "$IMAGE" = "unknown" ]; then
            echo "image_branch=unknown" >> $GITHUB_OUTPUT
            echo "image_commit=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ Cannot parse image tag - image is unknown"
          else
            # æå–æ ‡ç­¾éƒ¨åˆ†ï¼ˆæœ€åä¸€ä¸ªå†’å·åçš„å†…å®¹ï¼‰
            TAG=${IMAGE##*:}

            # è§£ææ ‡ç­¾ï¼šBRANCH-DATE-COMMIT
            IFS='-' read -r BRANCH DATE COMMIT <<< "$TAG"

            echo "image_branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "image_commit=$COMMIT" >> $GITHUB_OUTPUT

            echo "âœ… Parsed image tag - Branch: $BRANCH, Date: $DATE, Commit: $COMMIT"
          fi

      # æ­¥éª¤7ï¼šç‰ˆæœ¬æ¯”è¾ƒå’Œç»“æœè¾“å‡º
      - name: Compare versions and show final results
        id: compare
        run: |
          echo "===== Version Comparison ====="

          # è·å–å„æ­¥éª¤çš„è¾“å‡ºå€¼
          API_COMMIT="${{ steps.fetch-commit.outputs.git_commit_id }}"
          IMAGE_COMMIT="${{ steps.parse-image.outputs.image_commit }}"
          API_BRANCH="${{ steps.fetch-branch.outputs.git_branch }}"
          IMAGE_BRANCH="${{ steps.parse-image.outputs.image_branch }}"
          IMAGE_FULL="${{ steps.extract-image.outputs.image }}"

          echo "Full Image: $IMAGE_FULL"
          echo "API Branch: $API_BRANCH"
          echo "Image Branch: $IMAGE_BRANCH"
          echo "API Commit: $API_COMMIT"
          echo "Image Commit: $IMAGE_COMMIT"
          echo ""

          # åˆ†æ”¯æ¯”è¾ƒ
          if [ "$API_BRANCH" = "$IMAGE_BRANCH" ] && [ "$API_BRANCH" != "unknown" ]; then
            echo "âœ… Branch match: $API_BRANCH"
          else
            echo "âŒ Branch mismatch! API: $API_BRANCH, Image: $IMAGE_BRANCH"
          fi

          # æäº¤IDæ¯”è¾ƒï¼ˆå°†å®Œæ•´æäº¤IDæˆªå–å‰7ä½ï¼‰
          if [ "$API_COMMIT" != "unknown" ] && [ "$IMAGE_COMMIT" != "unknown" ]; then
            API_COMMIT_SHORT=${API_COMMIT:0:7}
            if [ "$API_COMMIT_SHORT" = "$IMAGE_COMMIT" ]; then
              echo "âœ… Commit match: $API_COMMIT_SHORT"
              echo "ğŸ‰ Version consistency verified!"
            else
              echo "âŒ Commit mismatch! API: $API_COMMIT_SHORT, Image: $IMAGE_COMMIT"
              echo "âš ï¸ The running container image version does not match the latest code version."
              echo "ğŸ’¡ Consider updating the container image to the latest version."
            fi
          else
            echo "âš ï¸ Cannot compare commits - one or both values are unknown"
          fi

          echo ""
          echo "===== Summary ====="
          if [ "$API_BRANCH" = "unknown" ] || [ "$IMAGE_BRANCH" = "unknown" ] || [ "$API_COMMIT" = "unknown" ] || [ "$IMAGE_COMMIT" = "unknown" ]; then
            echo "âš ï¸ [WARNING] Some values are 'unknown' - check previous steps for issues."
          else
            echo "âœ… All values retrieved successfully"
          fi

          # è®¾ç½®ç‰ˆæœ¬ä¸ä¸€è‡´æ£€æµ‹æ ‡å¿—å’ŒæœåŠ¡å™¨çŠ¶æ€æ£€æµ‹
          VERSION_MISMATCH=false
          SERVER_DOWN=false

          # æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å®•æœº
          if [ "$API_BRANCH" = "server_down" ] || [ "$API_COMMIT" = "server_down" ]; then
            SERVER_DOWN=true
            echo "ğŸš¨ Server is down - cannot perform version comparison"
            echo "server_down=true" >> $GITHUB_OUTPUT
            echo "version_mismatch=false" >> $GITHUB_OUTPUT
          # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦ä¸ä¸€è‡´
          elif [ "$API_BRANCH" != "$IMAGE_BRANCH" ] || ([ "$API_COMMIT" != "unknown" ] && [ "$IMAGE_COMMIT" != "unknown" ] && [ "${API_COMMIT:0:7}" != "$IMAGE_COMMIT" ]); then
            VERSION_MISMATCH=true
            echo "version_mismatch=true" >> $GITHUB_OUTPUT
            echo "server_down=false" >> $GITHUB_OUTPUT
          else
            echo "version_mismatch=false" >> $GITHUB_OUTPUT
            echo "server_down=false" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤8ï¼šæœåŠ¡å™¨å®•æœºæ—¶å‘é€é£ä¹¦è­¦å‘Š
      - name: Send Feishu alert on server down
        if: steps.compare.outputs.server_down == 'true'
        run: |
          echo "ğŸš¨ Server down detected, sending Feishu alert..."

          # è·å–ç¯å¢ƒå˜é‡
          WEBHOOK_URL="https://open.feishu.cn/open-apis/bot/v2/hook/93854238-e45b-431e-a309-ec36daf581f6"

          if [ -z "$WEBHOOK_URL" ]; then
            echo "âš ï¸ [WARNING] FEISHU_WEBHOOK_URL not configured. Please add it to repository secrets."
            exit 0
          fi

          # è·å–åŸºæœ¬ä¿¡æ¯
          IMAGE_FULL="${{ steps.extract-image.outputs.image }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"

          # æ„å»ºæœåŠ¡å™¨å®•æœºè­¦å‘Šæ¶ˆæ¯
          cat << EOF > feishu_message.json
          {
            "msg_type": "text",
            "content": {
              "text": "ğŸš¨ æœåŠ¡å™¨å®•æœºè­¦å‘Š\n\nAPIæœåŠ¡å™¨æ— æ³•è®¿é—®ï¼\n\næ£€æµ‹è¯¦æƒ…ï¼š\n- ç»è¿‡3æ¬¡é‡è¯•ï¼Œæ¯æ¬¡100ç§’è¶…æ—¶\n- æ€»å°è¯•æ—¶é—´çº¦5åˆ†é’Ÿ\n- æœåŠ¡å™¨æ— å“åº”æˆ–è¿”å›é”™è¯¯\n\nå½“å‰è¿è¡Œçš„é•œåƒï¼š\n${IMAGE_FULL}\n\nç´§æ€¥å»ºè®®æ“ä½œï¼š\n1. ç«‹å³æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€\n2. è”ç³»è¿ç»´å›¢é˜Ÿå¤„ç†\n3. ç¡®è®¤æœåŠ¡å™¨ç½‘ç»œè¿æ¥\n4. æ£€æŸ¥æœåŠ¡è¿›ç¨‹æ˜¯å¦æ­£å¸¸è¿è¡Œ\n\nç›¸å…³é“¾æ¥ï¼š\nä»£ç ä»“åº“ï¼š${REPO_URL}\nAPIåœ°å€ï¼šhttps://gk-regir-docker-nvlgswjdem.cn-shenzhen.fcapp.run/ready/detail\n\nâš ï¸ æ­¤ä¸ºä¸¥é‡æ•…éšœï¼Œè¯·ç«‹å³å¤„ç†ï¼"
            }
          }
          EOF

          # å‘é€é£ä¹¦æ¶ˆæ¯
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @feishu_message.json)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Server down alert sent successfully!"
          else
            echo "âŒ Failed to send Feishu alert. HTTP code: $HTTP_CODE"
          fi

      # æ­¥éª¤9ï¼šç‰ˆæœ¬ä¸ä¸€è‡´æ—¶å‘é€é£ä¹¦è­¦å‘Š
      - name: Send Feishu alert on version mismatch
        if: steps.compare.outputs.version_mismatch == 'true'
        run: |
          echo "ğŸš¨ Version mismatch detected, sending Feishu alert..."

          # è·å–ç¯å¢ƒå˜é‡
          WEBHOOK_URL="https://open.feishu.cn/open-apis/bot/v2/hook/93854238-e45b-431e-a309-ec36daf581f6"

          if [ -z "$WEBHOOK_URL" ]; then
            echo "âš ï¸ [WARNING] FEISHU_WEBHOOK_URL not configured. Please add it to repository secrets."
            exit 0
          fi

          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          API_COMMIT="${{ steps.fetch-commit.outputs.git_commit_id }}"
          IMAGE_COMMIT="${{ steps.parse-image.outputs.image_commit }}"
          API_BRANCH="${{ steps.fetch-branch.outputs.git_branch }}"
          IMAGE_BRANCH="${{ steps.parse-image.outputs.image_branch }}"
          IMAGE_FULL="${{ steps.extract-image.outputs.image }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"

          # æ„å»ºé£ä¹¦æ–‡æœ¬æ¶ˆæ¯
          cat << EOF > feishu_message.json
          {
            "msg_type": "text",
            "content": {
              "text": "ğŸš¨ ç‰ˆæœ¬ä¸ä¸€è‡´è­¦å‘Š\n\nç‰ˆæœ¬å¯¹æ¯”ä¿¡æ¯ï¼š\næµ‹è¯•ç¯å¢ƒç‰ˆæœ¬ï¼š\n  åˆ†æ”¯ï¼š${API_BRANCH}\n  æäº¤ï¼š${API_COMMIT:0:7}\ns.yamlå£°æ˜ç‰ˆæœ¬ï¼š\n  åˆ†æ”¯ï¼š${IMAGE_BRANCH}\n  æäº¤ï¼š${IMAGE_COMMIT}\n\nå½“å‰é•œåƒï¼š\n${IMAGE_FULL}\n\nå»ºè®®æ“ä½œï¼š\n1. æ£€æŸ¥éƒ¨ç½²æµç¨‹æ˜¯å¦æ­£å¸¸\n2. æ›´æ–°å®¹å™¨é•œåƒåˆ°æœ€æ–°ç‰ˆæœ¬\n3. ç¡®è®¤ä»£ç ç‰ˆæœ¬ä¸éƒ¨ç½²ç‰ˆæœ¬ä¸€è‡´\n\nç›¸å…³é“¾æ¥ï¼š\nä»£ç ä»“åº“ï¼š${REPO_URL}\nAPIçŠ¶æ€ï¼šhttps://gk-regir-docker-nvlgswjdem.cn-shenzhen.fcapp.run/ready/detail"
            }
          }
          EOF

          # å‘é€é£ä¹¦æ¶ˆæ¯
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @feishu_message.json)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… Feishu alert sent successfully!"
          else
            echo "âŒ Failed to send Feishu alert. HTTP code: $HTTP_CODE"
          fi