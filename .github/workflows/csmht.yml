name: Extract Image and Git Branch with Warnings
on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ main ]
    paths:
      - '**.yaml'

jobs:
  extract-info:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出当前仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：安装 yq 工具
      - name: Install yq
        run: |
          if ! command -v yq &> /dev/null; then
            echo "⚠️ yq not found, installing now..."
            sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
            sudo chmod +x /usr/bin/yq
          else
            echo "✅ yq is already installed"
          fi

      # 步骤3：从YAML提取image属性（含警告）
      - name: Extract image from YAML
        id: extract-image
        run: |
          YAML_FILE="s.yaml"  # 替换为实际YAML文件路径
          
          # 检查文件是否存在
          if [ ! -f "$YAML_FILE" ]; then
            echo "⚠️ [WARNING] YAML file '$YAML_FILE' not found in repository!"
            echo "image=unknown" >> $GITHUB_OUTPUT
            exit 0  # 不中断工作流，返回默认值
          fi
          
          # 提取属性值
          IMAGE_VALUE=$(yq eval '.resources.fcDemo.props.customContainerConfig.image' "$YAML_FILE")
          
          # 检查提取结果是否为空
          if [ -z "$IMAGE_VALUE" ] || [ "$IMAGE_VALUE" = "null" ]; then
            echo "⚠️ [WARNING] Failed to extract 'resources.fcDemo.props.customContainerConfig.image' from $YAML_FILE"
            IMAGE_VALUE="unknown"
          fi
          
          echo "✅ Extracted image: $IMAGE_VALUE"
          echo "image=$IMAGE_VALUE" >> $GITHUB_OUTPUT

      # 步骤4：访问接口获取git_branch（含警告）
      - name: Fetch git_branch from API
        id: fetch-branch
        run: |
          API_URL="https://gk-regir-docker-nvlgswjdem.cn-shenzhen.fcapp.run/ready/detail"  # 实际接口地址
          
          # 检查接口URL是否配置
          if [ -z "$API_URL" ] || [ "$API_URL" = "https://your-api-url.com/endpoint" ]; then
            echo "⚠️ [WARNING] API URL is not set or using default value! Please update API_URL."
            BRANCH_VALUE="unknown"
          else
            # 发送请求并分别获取响应体和HTTP状态码
            BODY=$(curl -s "$API_URL")
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL")
          
            # 检查HTTP状态码
            if [ "$HTTP_CODE" -ne 200 ]; then
              echo "⚠️ [WARNING] API request failed! HTTP status code: $HTTP_CODE"
              BRANCH_VALUE="unknown"
            else
              # 解析响应体中的git_branch
              BRANCH_VALUE=$(echo "$BODY" | jq -r '.details.git_branch')
              if [ "$BRANCH_VALUE" = "null" ] || [ -z "$BRANCH_VALUE" ]; then
                echo "⚠️ [WARNING] 'details.git_branch' not found in API response! Response: $BODY"
                BRANCH_VALUE="unknown"
              fi
            fi
          fi
          
          echo "✅ Fetched git_branch: $BRANCH_VALUE"
          echo "git_branch=$BRANCH_VALUE" >> $GITHUB_OUTPUT

      # 步骤5：汇总结果（含警告提示）
      - name: Show final results
        run: |
          echo "===== Extracted Information ====="
          echo "Image from YAML: ${{ steps.extract-image.outputs.image }}"
          echo "Git Branch from API: ${{ steps.fetch-branch.outputs.git_branch }}"
          
          # 检查是否有未知值并提示
          if [ "${{ steps.extract-image.outputs.image }}" = "unknown" ] || [ "${{ steps.fetch-branch.outputs.git_branch }}" = "unknown" ]; then
            echo "⚠️ [WARNING] Some values are 'unknown' - check previous steps for issues."
          fi