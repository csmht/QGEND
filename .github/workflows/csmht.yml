name: Extract Image and Git Branch
on:
  workflow_dispatch:  # 手动触发
  push:
    branches: [ main ]
    paths:
      - '**.yaml'

jobs:
  extract-info:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出当前仓库代码（用于读取YAML文件）
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：安装 yq 工具（解析YAML）
      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

      # 步骤3：从YAML文件提取image属性
      - name: Extract image from YAML
        id: extract-image
        run: |
          YAML_FILE="s.yaml"  # 替换为你的YAML文件路径（如实际文件名不同）
          if [ ! -f "$YAML_FILE" ]; then
            echo "Error: YAML file $YAML_FILE not found!"
            exit 1
          fi
          # 提取 resources.fcDemo.props.customContainerConfig.image
          IMAGE_VALUE=$(yq eval '.resources.fcDemo.props.customContainerConfig.image' "$YAML_FILE")
          echo "Extracted image: $IMAGE_VALUE"
          echo "image=$IMAGE_VALUE" >> $GITHUB_OUTPUT

      # 步骤4：访问指定接口，获取details.git_branch
      - name: Fetch git_branch from API
        id: fetch-branch
        run: |
          # 替换为你的目标接口URL（例如：https://api.example.com/status）
          API_URL="https://your-api-url.com/endpoint"  # 请修改为实际接口地址
          
          # 发送请求并解析返回值中的 details.git_branch
          # 使用curl请求，jq解析JSON（若接口返回JSON格式）
          BRANCH_VALUE=$(curl -s "$API_URL" | jq -r '.details.git_branch')
          
          # 检查提取结果（若接口返回非JSON格式，需调整解析方式）
          if [ "$BRANCH_VALUE" = "null" ] || [ -z "$BRANCH_VALUE" ]; then
            echo "Warning: Failed to extract details.git_branch from API"
            BRANCH_VALUE="unknown"  # 默认为unknown，避免空值
          fi
          
          echo "Fetched git_branch: $BRANCH_VALUE"
          echo "git_branch=$BRANCH_VALUE" >> $GITHUB_OUTPUT

      # 步骤5：输出最终结果
      - name: Show all results
        run: |
          echo "===== Extracted Information ====="
          echo "Image from YAML: ${{ steps.extract-image.outputs.image }}"
          echo "Git Branch from API: ${{ steps.fetch-branch.outputs.git_branch }}"