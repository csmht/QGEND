name: 每日域名WHOIS与SSL证书检测

on:
  schedule:
    - cron: '0 0 * * *'  # 每日UTC 0点（北京时间8点）运行
  workflow_dispatch:  # 支持手动触发

jobs:
  check-domain-cert:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      WARNING_DAYS: 60  # 全局警告阈值（这里统一修改，控制所有警告线）
    steps:
      - name: 安装WHOIS和jq工具
        run: sudo apt-get update && sudo apt-get install -y whois jq

      # 检查主域名WHOIS信息（引用全局变量）
      - name: 检查主域名 bushanyanchi.com WHOIS信息
        id: check_domain_whois
        run: |
          MAIN_DOMAIN="bushanyanchi.com"
          whois $MAIN_DOMAIN > whois_result.txt
          
          EXPIRE_TIME=$(grep -iE 'Registry Expiry Date|Expiration Date|expires|Expiry Date' whois_result.txt | head -1 | awk -F': ' '{print $2}' | xargs)
          EXPIRE_TIME_CLEAN=$(echo $EXPIRE_TIME | sed 's/T/ /g' | sed 's/Z//g')
          
          if [ -n "$EXPIRE_TIME_CLEAN" ]; then
            EXPIRE_TIMESTAMP=$(date -d "$EXPIRE_TIME_CLEAN" +%s 2>/dev/null)
            CURRENT_TIMESTAMP=$(date +%s)
            REMAIN_DAYS=$(( (EXPIRE_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
          
            if [ $REMAIN_DAYS -lt 0 ]; then
              REMAIN_DAYS="已过期（$((-REMAIN_DAYS)) 天）"
              DOMAIN_RISK="🚨 主域名已过期！请立即处理！"
            elif [ $REMAIN_DAYS -lt $WARNING_DAYS ]; then  # 引用全局变量
              REMAIN_DAYS="$REMAIN_DAYS 天（即将过期）"
              DOMAIN_RISK="⚠️ 主域名剩余天数不足$WARNING_DAYS天，需尽快续费！"  # 引用全局变量
            else
              REMAIN_DAYS="$REMAIN_DAYS 天"
              DOMAIN_RISK=""
            fi
          else
            EXPIRE_TIME="未查询到"
            REMAIN_DAYS="未知"
            DOMAIN_RISK="❓ 无法获取域名到期信息，请手动检查"
          fi
          
          echo "expire_time=$EXPIRE_TIME" >> $GITHUB_OUTPUT
          echo "remain_days=$REMAIN_DAYS" >> $GITHUB_OUTPUT
          echo "domain_risk=$DOMAIN_RISK" >> $GITHUB_OUTPUT

      # 检查子域名SSL证书（引用全局变量）
      - name: 检查子域名SSL证书
        id: check_subdomain_cert
        run: |
          SUB_DOMAINS=("gk.bushanyanchi.com" "gk-admin.bushanyanchi.com")
          CERT_RESULTS=""
          CERT_RISK=""
          
          for DOMAIN in "${SUB_DOMAINS[@]}"; do
            CERT=$(echo | timeout 10s openssl s_client -connect $DOMAIN:443 -servername $DOMAIN 2>/dev/null | openssl x509 -noout -dates 2>/dev/null)
          
            if [ -n "$CERT" ]; then
              NOT_BEFORE=$(echo "$CERT" | grep 'notBefore' | awk -F'=' '{print $2}' | xargs)
              NOT_AFTER=$(echo "$CERT" | grep 'notAfter' | awk -F'=' '{print $2}' | xargs)
              NOT_AFTER_TIMESTAMP=$(date -d "$NOT_AFTER" +%s 2>/dev/null)
              CURRENT_TIMESTAMP=$(date +%s)
              REMAIN_DAYS=$(( (NOT_AFTER_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
          
              if [ $REMAIN_DAYS -lt 0 ]; then
                REMAIN_DAYS="已过期（$((-REMAIN_DAYS)) 天）"
                CERT_RISK+="🚨 $DOMAIN 证书已过期！请立即更新！\n"
              elif [ $REMAIN_DAYS -lt $WARNING_DAYS ]; then  # 引用全局变量
                REMAIN_DAYS="$REMAIN_DAYS 天（即将过期）"
                CERT_RISK+="⚠️ $DOMAIN 证书剩余天数不足$WARNING_DAYS天，需尽快更新！\n"  # 引用全局变量
              else
                REMAIN_DAYS="$REMAIN_DAYS 天"
              fi
            else
              NOT_BEFORE="未获取到证书"
              NOT_AFTER="未获取到证书"
              REMAIN_DAYS="无法连接（检查域名解析或443端口）"
              CERT_RISK+="❌ $DOMAIN 无法获取证书信息，请手动检查！\n"
            fi
          
            CERT_RESULTS+="🔹 $DOMAIN\n   - 生效时间：$NOT_BEFORE\n   - 到期时间：$NOT_AFTER\n   - 剩余天数：$REMAIN_DAYS\n\n"
          done
          
          echo "cert_results=$CERT_RESULTS" >> $GITHUB_OUTPUT
          echo "cert_risk=$CERT_RISK" >> $GITHUB_OUTPUT

      # 发送飞书检测报告（引用全局变量）
      - name: 发送飞书检测报告
        run: |
          ALL_RISKS=$(cat <<EOF
          ${{ steps.check_domain_whois.outputs.domain_risk }}
          ${{ steps.check_subdomain_cert.outputs.cert_risk }}
          EOF
          )
          
          NOTIFY_CONTENT=$(cat <<EOF
          {
            "msg_type": "markdown",
            "content": {
              "title": "🌐 每日域名与证书检测报告",
              "text": "### 主域名 WHOIS 检查\n"
                      "🔸 域名：bushanyanchi.com\n"
                      "   - 到期时间：${{ steps.check_domain_whois.outputs.expire_time }}\n"
                      "   - 剩余天数：${{ steps.check_domain_whois.outputs.remain_days }}\n\n"
                      "### 子域名 SSL 证书检查\n"
                      "${{ steps.check_subdomain_cert.outputs.cert_results }}"
                      "$([ -n "$ALL_RISKS" ] && echo "### 风险警示\n$ALL_RISKS" || echo "### 状态正常\n所有域名和证书剩余天数均≥$WARNING_DAYS天")"  # 引用全局变量
            }
          }
          EOF
          )
          
          curl -X POST \
            "https://open.feishu.cn/open-apis/bot/v2/hook/e7b9814a-2005-4d48-8861-2b251ffe0cf6" \
            -H "Content-Type: application/json" \
            -d "$NOTIFY_CONTENT"
        env:
          SHELL: /bin/bash