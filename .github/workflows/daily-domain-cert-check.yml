name: æ¯æ—¥åŸŸåWHOISä¸SSLè¯ä¹¦æ£€æµ‹

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è¿è¡Œ
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  check-domain-cert:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      WARNING_DAYS: 60  # å…¨å±€è­¦å‘Šé˜ˆå€¼ï¼ˆè¿™é‡Œç»Ÿä¸€ä¿®æ”¹ï¼Œæ§åˆ¶æ‰€æœ‰è­¦å‘Šçº¿ï¼‰
    steps:
      - name: å®‰è£…WHOISå’Œjqå·¥å…·
        run: sudo apt-get update && sudo apt-get install -y whois jq

      # æ£€æŸ¥ä¸»åŸŸåWHOISä¿¡æ¯ï¼ˆå¼•ç”¨å…¨å±€å˜é‡ï¼‰
      - name: æ£€æŸ¥ä¸»åŸŸå bushanyanchi.com WHOISä¿¡æ¯
        id: check_domain_whois
        run: |
          MAIN_DOMAIN="bushanyanchi.com"
          whois $MAIN_DOMAIN > whois_result.txt
          
          EXPIRE_TIME=$(grep -iE 'Registry Expiry Date|Expiration Date|expires|Expiry Date' whois_result.txt | head -1 | awk -F': ' '{print $2}' | xargs)
          EXPIRE_TIME_CLEAN=$(echo $EXPIRE_TIME | sed 's/T/ /g' | sed 's/Z//g')
          
          if [ -n "$EXPIRE_TIME_CLEAN" ]; then
            EXPIRE_TIMESTAMP=$(date -d "$EXPIRE_TIME_CLEAN" +%s 2>/dev/null)
            CURRENT_TIMESTAMP=$(date +%s)
            REMAIN_DAYS=$(( (EXPIRE_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
          
            if [ $REMAIN_DAYS -lt 0 ]; then
              REMAIN_DAYS="å·²è¿‡æœŸï¼ˆ$((-REMAIN_DAYS)) å¤©ï¼‰"
              DOMAIN_RISK="ğŸš¨ ä¸»åŸŸåå·²è¿‡æœŸï¼è¯·ç«‹å³å¤„ç†ï¼"
            elif [ $REMAIN_DAYS -lt $WARNING_DAYS ]; then  # å¼•ç”¨å…¨å±€å˜é‡
              REMAIN_DAYS="$REMAIN_DAYS å¤©ï¼ˆå³å°†è¿‡æœŸï¼‰"
              DOMAIN_RISK="âš ï¸ ä¸»åŸŸåå‰©ä½™å¤©æ•°ä¸è¶³$WARNING_DAYSå¤©ï¼Œéœ€å°½å¿«ç»­è´¹ï¼"  # å¼•ç”¨å…¨å±€å˜é‡
            else
              REMAIN_DAYS="$REMAIN_DAYS å¤©"
              DOMAIN_RISK=""
            fi
          else
            EXPIRE_TIME="æœªæŸ¥è¯¢åˆ°"
            REMAIN_DAYS="æœªçŸ¥"
            DOMAIN_RISK="â“ æ— æ³•è·å–åŸŸååˆ°æœŸä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
          fi
          
          echo "expire_time=$EXPIRE_TIME" >> $GITHUB_OUTPUT
          echo "remain_days=$REMAIN_DAYS" >> $GITHUB_OUTPUT
          echo "domain_risk=$DOMAIN_RISK" >> $GITHUB_OUTPUT

      # æ£€æŸ¥å­åŸŸåSSLè¯ä¹¦ï¼ˆå¼•ç”¨å…¨å±€å˜é‡ï¼‰
      - name: æ£€æŸ¥å­åŸŸåSSLè¯ä¹¦
        id: check_subdomain_cert
        run: |
          SUB_DOMAINS=("gk.bushanyanchi.com" "gk-admin.bushanyanchi.com")
          CERT_RESULTS=""
          CERT_RISK=""
          
          for DOMAIN in "${SUB_DOMAINS[@]}"; do
            CERT=$(echo | timeout 10s openssl s_client -connect $DOMAIN:443 -servername $DOMAIN 2>/dev/null | openssl x509 -noout -dates 2>/dev/null)
          
            if [ -n "$CERT" ]; then
              NOT_BEFORE=$(echo "$CERT" | grep 'notBefore' | awk -F'=' '{print $2}' | xargs)
              NOT_AFTER=$(echo "$CERT" | grep 'notAfter' | awk -F'=' '{print $2}' | xargs)
              NOT_AFTER_TIMESTAMP=$(date -d "$NOT_AFTER" +%s 2>/dev/null)
              CURRENT_TIMESTAMP=$(date +%s)
              REMAIN_DAYS=$(( (NOT_AFTER_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
          
              if [ $REMAIN_DAYS -lt 0 ]; then
                REMAIN_DAYS="å·²è¿‡æœŸï¼ˆ$((-REMAIN_DAYS)) å¤©ï¼‰"
                CERT_RISK+="ğŸš¨ $DOMAIN è¯ä¹¦å·²è¿‡æœŸï¼è¯·ç«‹å³æ›´æ–°ï¼
"
              elif [ $REMAIN_DAYS -lt $WARNING_DAYS ]; then  # å¼•ç”¨å…¨å±€å˜é‡
                REMAIN_DAYS="$REMAIN_DAYS å¤©ï¼ˆå³å°†è¿‡æœŸï¼‰"
                CERT_RISK+="âš ï¸ $DOMAIN è¯ä¹¦å‰©ä½™å¤©æ•°ä¸è¶³$WARNING_DAYSå¤©ï¼Œéœ€å°½å¿«æ›´æ–°ï¼
"  # å¼•ç”¨å…¨å±€å˜é‡
              else
                REMAIN_DAYS="$REMAIN_DAYS å¤©"
              fi
            else
              NOT_BEFORE="æœªè·å–åˆ°è¯ä¹¦"
              NOT_AFTER="æœªè·å–åˆ°è¯ä¹¦"
              REMAIN_DAYS="æ— æ³•è¿æ¥ï¼ˆæ£€æŸ¥åŸŸåè§£ææˆ–443ç«¯å£ï¼‰"
              CERT_RISK+="âŒ $DOMAIN æ— æ³•è·å–è¯ä¹¦ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ï¼
"
            fi

            CERT_RESULTS+="ğŸ”¹ $DOMAIN
   - ç”Ÿæ•ˆæ—¶é—´ï¼š$NOT_BEFORE
   - åˆ°æœŸæ—¶é—´ï¼š$NOT_AFTER
   - å‰©ä½™å¤©æ•°ï¼š$REMAIN_DAYS

"
          done
          
          echo "cert_results=$CERT_RESULTS" >> $GITHUB_OUTPUT
          echo "cert_risk=$CERT_RISK" >> $GITHUB_OUTPUT

      # å‘é€é£ä¹¦æ£€æµ‹æŠ¥å‘Šï¼ˆä»…åœ¨æœ‰é£é™©æ—¶å‘é€ï¼‰
      - name: å‘é€é£ä¹¦æ£€æµ‹æŠ¥å‘Š
        if: contains(steps.check_domain_whois.outputs.domain_risk, 'ğŸš¨') || contains(steps.check_subdomain_cert.outputs.cert_risk, 'ğŸš¨') || contains(steps.check_domain_whois.outputs.domain_risk, 'âš ï¸') || contains(steps.check_subdomain_cert.outputs.cert_risk, 'âš ï¸')
        run: |
          # ç”Ÿæˆç®€æ´çš„æ–‡æœ¬é€šçŸ¥å†…å®¹
          ALERT_MESSAGE="åŸŸåè¿‡æœŸæé†’ï¼š
"

          # æ·»åŠ åŸŸåé£é™©ä¿¡æ¯
          if [ -n "${{ steps.check_domain_whois.outputs.domain_risk }}" ]; then
            ALERT_MESSAGE+="${{ steps.check_domain_whois.outputs.domain_risk }}
"
          fi

          # æ·»åŠ è¯ä¹¦é£é™©ä¿¡æ¯
          if [ -n "${{ steps.check_subdomain_cert.outputs.cert_risk }}" ]; then
            # ç§»é™¤æœ€åçš„æ¢è¡Œç¬¦ï¼Œé¿å…å¤šä½™ç©ºè¡Œ
            CERT_RISK_CLEAN=$(echo "${{ steps.check_subdomain_cert.outputs.cert_risk }}" | sed 's/$//' | sed 's/\\n$//')
            ALERT_MESSAGE+="$CERT_RISK_CLEAN
"
          fi

          NOTIFY_CONTENT=$(cat <<EOF
          {
            "msg_type": "text",
            "content": {
                "text": "$ALERT_MESSAGE"
            }
          }
          EOF
          )

          # æ‰“å°å³å°†å‘é€çš„æ¶ˆæ¯å†…å®¹
          echo "ğŸ“¤ å³å°†å‘é€é£ä¹¦é€šçŸ¥..."
          echo "==================================="
          echo "é€šçŸ¥ç±»å‹ï¼štextï¼ˆçº¯æ–‡æœ¬ï¼‰"
          echo "å‘é€æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "æ£€æµ‹åˆ°é£é™©é¡¹ç›®ï¼š"
          if [ -n "${{ steps.check_domain_whois.outputs.domain_risk }}" ]; then
            echo "  - åŸŸåé£é™©ï¼š${{ steps.check_domain_whois.outputs.domain_risk }}"
          fi
          if [ -n "${{ steps.check_subdomain_cert.outputs.cert_risk }}" ]; then
            echo "  - è¯ä¹¦é£é™©ï¼š${{ steps.check_subdomain_cert.outputs.cert_risk }}"
          fi
          echo "==================================="
          echo "å‘é€æ¶ˆæ¯å†…å®¹ï¼š"
          echo "$ALERT_MESSAGE"
          echo "==================================="
          echo "å®Œæ•´JSONæ ¼å¼ï¼š"
          echo "$NOTIFY_CONTENT" | jq '.' 2>/dev/null || echo "$NOTIFY_CONTENT"
          echo "==================================="

          # å‘é€é£ä¹¦é€šçŸ¥
          curl -X POST \
            "https://open.feishu.cn/open-apis/bot/v2/hook/e7b9814a-2005-4d48-8861-2b251ffe0cf6" \
            -H "Content-Type: application/json" \
            -d "$NOTIFY_CONTENT"

          echo "âœ… é£ä¹¦é€šçŸ¥å‘é€å®Œæˆ"

      # è®°å½•æ— é£é™©çŠ¶æ€
      - name: è®°å½•æ— é£é™©çŠ¶æ€
        if: ${{ !contains(steps.check_domain_whois.outputs.domain_risk, 'ğŸš¨') && !contains(steps.check_domain_whois.outputs.domain_risk, 'âš ï¸') && !contains(steps.check_subdomain_cert.outputs.cert_risk, 'ğŸš¨') && !contains(steps.check_subdomain_cert.outputs.cert_risk, 'âš ï¸') }}
        run: |
          echo "âœ… æ‰€æœ‰æ£€æµ‹é¡¹ç›®æ­£å¸¸ï¼Œå‰©ä½™å¤©æ•°å‡â‰¥60å¤©"
          echo "ğŸ”¹ ä¸»åŸŸåå‰©ä½™å¤©æ•°ï¼š${{ steps.check_domain_whois.outputs.remain_days }}"
          echo "ğŸ”¹ SSLè¯ä¹¦çŠ¶æ€æ­£å¸¸ï¼Œæ— éœ€å‘é€é€šçŸ¥"
          echo "ğŸ“… æ£€æµ‹æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S UTC')"