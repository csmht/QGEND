name: æ¯æ—¥åŸŸåWHOISä¸SSLè¯ä¹¦æ£€æµ‹

on:
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è¿è¡Œ
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs
  check-domain-cert:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      WARNING_DAYS: 30  # å…¨å±€è­¦å‘Šé˜ˆå€¼ï¼ˆè¿™é‡Œç»Ÿä¸€ä¿®æ”¹ï¼Œæ§åˆ¶æ‰€æœ‰è­¦å‘Šçº¿ï¼‰
    steps:
      - name: å®‰è£…WHOISå’Œjqå·¥å…·
        run: sudo apt-get update && sudo apt-get install -y whois jq

      # æ£€æŸ¥ä¸»åŸŸåWHOISä¿¡æ¯ï¼ˆå¼•ç”¨å…¨å±€å˜é‡ï¼Œå¢åŠ é‡è¯•æœºåˆ¶ï¼‰
      - name: æ£€æŸ¥ä¸»åŸŸå bushanyanchi.com WHOISä¿¡æ¯
        id: check_domain_whois
        run: |
          MAIN_DOMAIN="bushanyanchi.com"

          # é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
          RETRY_COUNT=0
          MAX_RETRIES=3
          WHOIS_SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "WHOISæŸ¥è¯¢å°è¯• $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            if whois $MAIN_DOMAIN > whois_result.txt 2>/dev/null; then
              echo "âœ… WHOISæŸ¥è¯¢æˆåŠŸ"
              WHOIS_SUCCESS=true
              break
            else
              echo "âŒ WHOISæŸ¥è¯¢å¤±è´¥"
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "ç­‰å¾…3ç§’åé‡è¯•..."
                sleep 3
              fi
            fi
          done

          if [ "$WHOIS_SUCCESS" = false ]; then
            echo "âŒ WHOISæŸ¥è¯¢å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"
            EXPIRE_TIME="æŸ¥è¯¢å¤±è´¥"
            REMAIN_DAYS="æœªçŸ¥"
            DOMAIN_RISK="âŒ WHOISæŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥"
          else
            # æ”¯æŒæ›´å¤šå­—æ®µæ ¼å¼
            EXPIRE_FIELDS=("Registry Expiry Date" "Expiration Date" "expires" "Expiry Date" "paid-till" "registry expiry date")
            EXPIRE_TIME=""

            for FIELD in "${EXPIRE_FIELDS[@]}"; do
              # ä½¿ç”¨æ›´çµæ´»çš„åŒ¹é…æ–¹å¼ï¼Œæ”¯æŒå‰åç©ºæ ¼å’Œä¸åŒåˆ†éš”ç¬¦
              EXPIRE_TIME=$(grep -i "^[[:space:]]*$FIELD[[:space:]]*:" whois_result.txt | head -1 | awk -F': ' '{print $2}' | xargs)
              if [ -n "$EXPIRE_TIME" ]; then
                echo "âœ… æ‰¾åˆ°åˆ°æœŸæ—¶é—´å­—æ®µï¼š$FIELD"
                break
              fi
            done

            if [ -z "$EXPIRE_TIME" ]; then
              echo "âš ï¸ æœªèƒ½ä»WHOISè®°å½•ä¸­æå–åˆ°æœŸæ—¶é—´"
              echo "WHOISè®°å½•å†…å®¹ï¼š"
              cat whois_result.txt
              EXPIRE_TIME="æœªæå–åˆ°"
              REMAIN_DAYS="æœªçŸ¥"
              DOMAIN_RISK="â“ æ— æ³•è·å–åŸŸååˆ°æœŸä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
            else
              # æ ‡å‡†åŒ–æ—¶é—´æ ¼å¼
              EXPIRE_TIME_CLEAN=$(echo $EXPIRE_TIME | sed 's/T/ /g' | sed 's/Z//g' | sed 's/\..*//g')

              if EXPIRE_TIMESTAMP=$(date -d "$EXPIRE_TIME_CLEAN" +%s 2>/dev/null); then
                CURRENT_TIMESTAMP=$(date +%s)
                REMAIN_DAYS=$(( (EXPIRE_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))

                if [ $REMAIN_DAYS -lt 0 ]; then
                  REMAIN_DAYS="å·²è¿‡æœŸï¼ˆ$((-REMAIN_DAYS)) å¤©ï¼‰"
                  DOMAIN_RISK="ğŸš¨ ä¸»åŸŸåå·²è¿‡æœŸï¼è¯·ç«‹å³å¤„ç†ï¼"
                elif [ $REMAIN_DAYS -lt $WARNING_DAYS ]; then
                  REMAIN_DAYS="$REMAIN_DAYS å¤©ï¼ˆå³å°†è¿‡æœŸï¼‰"
                  DOMAIN_RISK="âš ï¸ ä¸»åŸŸåå‰©ä½™å¤©æ•°ä¸è¶³$WARNING_DAYSå¤©ï¼Œéœ€å°½å¿«ç»­è´¹ï¼"
                else
                  REMAIN_DAYS="$REMAIN_DAYS å¤©"
                  DOMAIN_RISK=""
                fi
              else
                echo "âŒ æ—¶é—´æ ¼å¼è½¬æ¢å¤±è´¥ï¼š$EXPIRE_TIME_CLEAN"
                EXPIRE_TIME="$EXPIRE_TIMEï¼ˆæ ¼å¼å¼‚å¸¸ï¼‰"
                REMAIN_DAYS="è§£æå¤±è´¥"
                DOMAIN_RISK="âŒ æ—¶é—´æ ¼å¼è§£æå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
              fi
            fi
          fi

          echo "expire_time=$EXPIRE_TIME" >> $GITHUB_OUTPUT
          echo "remain_days=$REMAIN_DAYS" >> $GITHUB_OUTPUT
          echo "domain_risk=$DOMAIN_RISK" >> $GITHUB_OUTPUT

      # æ£€æŸ¥å­åŸŸåSSLè¯ä¹¦ï¼ˆå¼•ç”¨å…¨å±€å˜é‡ï¼‰
      - name: æ£€æŸ¥å­åŸŸåSSLè¯ä¹¦
        id: check_subdomain_cert
        run: |
          SUB_DOMAINS=("gk.bushanyanchi.com" "gk-admin.bushanyanchi.com")
          CERT_RESULTS=""
          CERT_RISK=""
          
          for DOMAIN in "${SUB_DOMAINS[@]}"; do
            echo "æ£€æµ‹åŸŸåï¼š$DOMAIN"

            # é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š2æ¬¡ï¼‰
            RETRY_COUNT=0
            MAX_RETRIES=2
            CERT_SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "SSLè¯ä¹¦æ£€æµ‹å°è¯• $((RETRY_COUNT + 1))/$MAX_RETRIES..."
              CERT=$(echo | timeout 15s openssl s_client -connect $DOMAIN:443 -servername $DOMAIN 2>/dev/null | openssl x509 -noout -dates 2>/dev/null)

              if [ -n "$CERT" ]; then
                echo "âœ… SSLè¯ä¹¦è·å–æˆåŠŸ"
                CERT_SUCCESS=true
                break
              else
                echo "âŒ SSLè¯ä¹¦è·å–å¤±è´¥"
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "ç­‰å¾…2ç§’åé‡è¯•..."
                  sleep 2
                fi
              fi
            done

            if [ "$CERT_SUCCESS" = true ]; then
              NOT_BEFORE=$(echo "$CERT" | grep 'notBefore' | awk -F'=' '{print $2}' | xargs)
              NOT_AFTER=$(echo "$CERT" | grep 'notAfter' | awk -F'=' '{print $2}' | xargs)
              NOT_AFTER_TIMESTAMP=$(date -d "$NOT_AFTER" +%s 2>/dev/null)
              CURRENT_TIMESTAMP=$(date +%s)
              REMAIN_DAYS=$(( (NOT_AFTER_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
          
              if [ $REMAIN_DAYS -lt 0 ]; then
                REMAIN_DAYS="å·²è¿‡æœŸï¼ˆ$((-REMAIN_DAYS)) å¤©ï¼‰"
                CERT_RISK+="ğŸš¨ $DOMAIN è¯ä¹¦å·²è¿‡æœŸï¼è¯·ç«‹å³æ›´æ–°ï¼\n"
              elif [ $REMAIN_DAYS -lt $WARNING_DAYS ]; then  # å¼•ç”¨å…¨å±€å˜é‡
                REMAIN_DAYS="$REMAIN_DAYS å¤©ï¼ˆå³å°†è¿‡æœŸï¼‰"
                CERT_RISK+="âš ï¸ $DOMAIN è¯ä¹¦å‰©ä½™å¤©æ•°ä¸è¶³$WARNING_DAYSå¤©ï¼Œéœ€å°½å¿«æ›´æ–°ï¼\n"  # å¼•ç”¨å…¨å±€å˜é‡
              else
                REMAIN_DAYS="$REMAIN_DAYS å¤©"
              fi
            else
              NOT_BEFORE="æœªè·å–åˆ°è¯ä¹¦"
              NOT_AFTER="æœªè·å–åˆ°è¯ä¹¦"
              REMAIN_DAYS="æ— æ³•è¿æ¥ï¼ˆæ£€æŸ¥åŸŸåè§£ææˆ–443ç«¯å£ï¼‰"
              CERT_RISK+="âŒ $DOMAIN æ— æ³•è·å–è¯ä¹¦ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ï¼\n"
            fi

            CERT_RESULTS+="ğŸ”¹ $DOMAIN\n   - ç”Ÿæ•ˆæ—¶é—´ï¼š$NOT_BEFORE\n   - åˆ°æœŸæ—¶é—´ï¼š$NOT_AFTER\n   - å‰©ä½™å¤©æ•°ï¼š$REMAIN_DAYS\n\n"
          done
          
          echo "cert_results=$CERT_RESULTS" >> $GITHUB_OUTPUT
          echo "cert_risk=$CERT_RISK" >> $GITHUB_OUTPUT

      # å‘é€é£ä¹¦æ£€æµ‹æŠ¥å‘Šï¼ˆä»…åœ¨æœ‰é£é™©æ—¶å‘é€ï¼‰
      - name: å‘é€é£ä¹¦æ£€æµ‹æŠ¥å‘Š
        if: |
          contains(steps.check_domain_whois.outputs.domain_risk, 'è¿‡æœŸ') ||
          contains(steps.check_domain_whois.outputs.domain_risk, 'ä¸è¶³') ||
          contains(steps.check_domain_whois.outputs.domain_risk, 'å¤±è´¥') ||
          contains(steps.check_subdomain_cert.outputs.cert_risk, 'è¿‡æœŸ') ||
          contains(steps.check_subdomain_cert.outputs.cert_risk, 'ä¸è¶³') ||
          contains(steps.check_subdomain_cert.outputs.cert_risk, 'æ— æ³•è·å–')
        run: |
          # ç”Ÿæˆç®€æ´çš„æ–‡æœ¬é€šçŸ¥å†…å®¹
          ALERT_MESSAGE="åŸŸåè¿‡æœŸæé†’ï¼š\n"

          # æ·»åŠ åŸŸåé£é™©ä¿¡æ¯å’Œå‰©ä½™å¤©æ•°
          if [ -n "${{ steps.check_domain_whois.outputs.domain_risk }}" ]; then
            ALERT_MESSAGE+="ğŸ“ åŸŸåä¿¡æ¯ï¼š\n"
            ALERT_MESSAGE+="  - çŠ¶æ€ï¼š${{ steps.check_domain_whois.outputs.domain_risk }}\n"
            ALERT_MESSAGE+="  - å‰©ä½™å¤©æ•°ï¼š${{ steps.check_domain_whois.outputs.remain_days }}\n"
            ALERT_MESSAGE+="  - åˆ°æœŸæ—¶é—´ï¼š${{ steps.check_domain_whois.outputs.expire_time }}\n\n"
          fi

          # æ·»åŠ è¯ä¹¦é£é™©ä¿¡æ¯
          if [ -n "${{ steps.check_subdomain_cert.outputs.cert_risk }}" ]; then
            ALERT_MESSAGE+="ğŸ”’ SSLè¯ä¹¦ä¿¡æ¯ï¼š\n"
            # ç§»é™¤æœ€åçš„æ¢è¡Œç¬¦ï¼Œé¿å…å¤šä½™ç©ºè¡Œ
            CERT_RISK_CLEAN=$(echo "${{ steps.check_subdomain_cert.outputs.cert_risk }}" | sed 's/$//' | tr -d '\n')
            ALERT_MESSAGE+="  - $CERT_RISK_CLEAN\n"
            ALERT_MESSAGE+="\nğŸ“‹ è¯¦ç»†è¯ä¹¦çŠ¶æ€ï¼š\n${{ steps.check_subdomain_cert.outputs.cert_results }}\n"
          fi

          NOTIFY_CONTENT=$(cat <<EOF
          {
            "msg_type": "text",
            "content": {
                "text": "$ALERT_MESSAGE"
            }
          }
          EOF
          )

          echo "ğŸ“¤ å‘é€é£ä¹¦é£é™©é€šçŸ¥..."
          echo "å‘é€æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "é€šçŸ¥å†…å®¹ï¼š$ALERT_MESSAGE"

          # å‘é€é£ä¹¦é€šçŸ¥å¹¶å¤„ç†é”™è¯¯
          if curl -X POST \
            "https://open.feishu.cn/open-apis/bot/v2/hook/93854238-e45b-431e-a309-ec36daf581f6" \
            -H "Content-Type: application/json" \
            -d "$NOTIFY_CONTENT" \
            --max-time 30 \
            --silent \
            --show-error \
            --fail-with-body; then
            echo "âœ… é£ä¹¦é€šçŸ¥å‘é€æˆåŠŸ"
          else
            echo "âŒ é£ä¹¦é€šçŸ¥å‘é€å¤±è´¥"
            echo "è¯·æ£€æŸ¥ FEISHU_WEBHOOK_URL å¯†é’¥é…ç½®æ˜¯å¦æ­£ç¡®"
            exit 1
          fi

      - name: è®°å½•æ— é£é™©çŠ¶æ€
        if: |
          !contains(steps.check_domain_whois.outputs.domain_risk, 'è¿‡æœŸ') &&
          !contains(steps.check_domain_whois.outputs.domain_risk, 'ä¸è¶³') &&
          !contains(steps.check_domain_whois.outputs.domain_risk, 'å¤±è´¥') &&
          !contains(steps.check_subdomain_cert.outputs.cert_risk, 'è¿‡æœŸ') &&
          !contains(steps.check_subdomain_cert.outputs.cert_risk, 'ä¸è¶³') &&
          !contains(steps.check_subdomain_cert.outputs.cert_risk, 'æ— æ³•è·å–')
        run: |
          echo "âœ… æ‰€æœ‰æ£€æµ‹é¡¹ç›®æ­£å¸¸ï¼Œå‰©ä½™å¤©æ•°å‡â‰¥60å¤©"
          echo "ğŸ”¹ ä¸»åŸŸåå‰©ä½™å¤©æ•°ï¼š${{ steps.check_domain_whois.outputs.remain_days }}"
          echo "ğŸ”¹ SSLè¯ä¹¦çŠ¶æ€æ­£å¸¸ï¼Œæ— éœ€å‘é€é€šçŸ¥"
          echo "ğŸ“… æ£€æµ‹æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S UTC')"
